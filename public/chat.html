<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="chat.css">

</head>


<body>

  <div class="main">
    <h2 id="roomName"></h2>
    <div id="chatBox" class="chat-box"></div>

    <div class="sender">
      <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    // URL parameters
    const url = new URLSearchParams(window.location.search);

    const room = url.get("room");
    const username = url.get("username");
    const sk = url.get("sk");

    if (!room || !username || !sk) {
      alert("Invalid user or room. Redirecting...");
      location.href = "index.html";
    }

    document.getElementById("roomName").innerText = "Room: " + room;

    // connect socket
    const socket = io({
      auth: {
        room,
        username,
        sk
      }
    });

    const chatBox = document.getElementById("chatBox");
    const sendBtn = document.getElementById("sendBtn");
    const msgI = document.getElementById("messageInput");

    // Send msg
    sendBtn.addEventListener("click", () => {
      const msg = msgI.value.trim();
      if (!msg) return;

      socket.emit("message", {
        username,
        msg,
        room
      });

      msgI.value = "";
    });

    msgI.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // Receive
    socket.on("message", (data) => {
      appendMessage(data.username, data.msg, data.timestamp);
    });

    // Joined
    socket.on("joined", (user) => {
      showNotification(`${user} joined`);
    });

    // Left
    socket.on("left", (user) => {
      showNotification(`${user} left`);
    });

    function appendMessage(user, message, time) {
      const div = document.createElement("div");
      div.classList.add("bubble");

      if (user === username) {
        div.classList.add("self");
      } else {
        div.classList.add("other");
      }

      div.innerHTML = `
        <p><b>${user}:</b> ${message}</p>
        <span>${new Date(time).toLocaleTimeString()}</span>
      `;

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showNotification(msg) {
      const div = document.createElement("div");
      div.classList.add("notify");
      div.innerHTML = msg;

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      setTimeout(() => div.remove(), 2000);
    }
  </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.10.3/qs.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="js/chat.js"></script>

</body>
</html>
